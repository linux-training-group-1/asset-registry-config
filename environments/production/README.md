# The Production Environment 
The production environment contains the Flask Application, Redis within the production K8s cluster's default namespace, Mysql outside the K8s cluster.<br>
ArgoDC runs in the argocd namespace and fluentd runs in the fluentd namespace.<br>
Config map will be automatically created/updated at each deployment. But secrets have to be created manually, 
after initializing the cluster<br>

[Asset registry repo](https://github.com/linux-training-group-1/asset-registry) contains the CI pipeline that will build and push the application docker images. Then the CI agent (GitHub Actions) will update this repository with the new k8s configs (Ex: new docker image versions).<br>
Argo CD(Deployed on K8s cluster) will monitor this repo and pull any changes to the K8s cluster.<br>
## Configure the Production K8s Cluster
### Install ArgoCD on k8s cluster <br>

```
kubectl create namespace argocd
kubectl create namespace prod
```
For ArgoCD and Production

```
kubectl apply -n argocd -f https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml
```
### Login to Argo CD server
```
kubectl port-forward -n argocd svc/argocd-server 8080:80
```
Username: admin<br>
Password: Initial password is autogenerated and stored as a secret.
```
kubectl get secret argocd-initial-admin-secret -n argocd -o yaml
```
copy the password and base64 decode it<br>
```
echo <password> | base64 --decode
```
Change the password using the GUI ( use `kubectl port-forward -n argocd svc/argocd-server 8080:80` and Login: [http://localhost:8080/](http://localhost:8080/) )<br>
### Apply the docker registry image pull secrets (regcred)
This config contains the credentials for the private docker registry.<br>
This secret can be found here<br>
https://docs.google.com/document/d/1wPSJVYKU5EWj_Lu7uTDaZhxoQJK2BvIB11MB7hpQfmQ/edit#<br>
Be sure to change the namespace property before applying the yaml resource <br>
### Spinup a cloud shell
Copy the secret to a file<br>
![cloud-shell](https://user-images.githubusercontent.com/32504465/145701482-95169c2c-3555-490b-bb0e-19ea83ef2f25.png)<br>
##### use kubectl apply
`kubectl apply -f <file-name.yaml>`
### Add other secrets as well - mysql username, password etc
### Create an argo project and deploy the artifacts<br>
Clone this project
```
git clone https://github.com/linux-training-group-1/asset-registry-config.git
```
Apply the Argocd application and the Kustomize config map
```
kubectl apply -f asset-registry-config/argocd/
```
This method of deploying the application only checks for changes every 3 minutes. If you want to immediately reflect the changes, integrate your GitHub account and select this project using the Argo CD GUI.<br> 

### Configure SSL
Lease an IP address from GCP.<br>
Lease a doamin name from freenom (we got `asset-app-grp1.ml`). Then point the domian name to the Production ingress's IP address<br>
![Screenshot from 2022-01-25 07-31-43](https://user-images.githubusercontent.com/32504465/150896958-9cdc7b5c-1905-4b9b-9123-d6a76ef79ad5.png)
<br>

Add a Google managed SSL certificate to the doamin name.
 ```
 kubectl apply -f asset-registry-config/environments/production/cert.yaml
 ```
You may have to wait upto 1 hour to get the certificate created for you.
